<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Tragaperras</title>

<!-- Fuente Ready Player 2P -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        background: #111;
        color: white;
        font-family: 'Press Start 2P', monospace;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        min-height: 100vh;
    }

    .slot-machine {
        background: #222;
        padding: 30px;
        border: 4px solid white;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    .slots {
        display: flex;
        gap: 20px;
        justify-content: center;
    }

    .slot {
        width: 80px;
        height: 120px;
        border: 3px solid white;
        font-size: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: black;
        transition: all 0.3s ease;
    }

    .maldito {
        color: black !important;
        background: white;
        animation: parpadeo 0.5s infinite alternate;
    }

    @keyframes parpadeo {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    #saldo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
    }

    #saldo img {
        width: 24px;
        height: 24px;
    }

    .apuesta-container {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
    }

    .apuesta-container input[type="number"] {
        width: 80px;
        font-family: 'Press Start 2P';
        font-size: 16px;
        text-align: center;
    }

    .apuesta-container button {
        font-family: 'Press Start 2P';
        font-size: 14px;
        padding: 4px 10px;
        cursor: pointer;
    }

    button#spinBtn {
        font-family: 'Press Start 2P';
        font-size: 16px;
        padding: 10px 30px;
        cursor: pointer;
        background: white;
        border: none;
        margin-top: 10px;
    }

    button:disabled {
        background: gray;
        cursor: not-allowed;
    }

    #debugPanel {
        display: none;
        margin-top: 20px;
        border: 2px dashed yellow;
        padding: 10px;
        color: yellow;
        font-size: 12px;
        text-align: left;
        width: 300px;
    }

    #debugPanel input, #debugPanel select, #debugPanel button {
        font-family: 'Press Start 2P';
        font-size: 12px;
        margin: 3px 0;
    }
</style>
</head>
<body>

<div id="loginDiv">
    <p>Introduce tu código:</p>
    <input type="text" id="loginCode" placeholder="Código de partida">
    <button onclick="login()">Entrar</button>
</div>

<div class="slot-machine" id="gameDiv" style="display:none;">
    <div id="saldo">
        Senselios: <span id="saldoValor">0</span> <img src="senselios.png" alt="Senselios">
    </div>

    <div class="slots">
        <div class="slot" id="slot1">1</div>
        <div class="slot" id="slot2">1</div>
        <div class="slot" id="slot3">1</div>
    </div>

    <div class="apuesta-container">
        <button onclick="cambiarApuesta(-1)">-</button>
        <input type="number" id="apuesta" value="10" min="1">
        <button onclick="cambiarApuesta(1)">+</button>
    </div>

    <button id="spinBtn" onclick="spin()">GIRAR</button>

    <div id="debugPanel">
        <p><b>DEBUG MODE</b></p>
        Añadir Senselios: <input type="number" id="addCash" value="0">
        <button onclick="agregarSenselios()">Añadir</button><br>
        Forzar slots (ej: 7,(7),3): <input type="text" id="forcedInput">
    </div>
</div>

<audio id="plac" src="plac.mp3"></audio>

<script>
let userCode = '';
let saldo = 0;
let debugMode = false;
let forcedNumbers = [];

// Colores para los números
const colors = ['#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF','#FFA500'];
const slots = [
    document.getElementById("slot1"),
    document.getElementById("slot2"),
    document.getElementById("slot3")
];
const spinBtn = document.getElementById("spinBtn");
const plac = document.getElementById("plac");

function login() {
    userCode = document.getElementById("loginCode").value.trim();
    if(!userCode) return alert("Introduce un código válido");

    debugMode = (userCode === 'GodIsHere');

    const saved = JSON.parse(localStorage.getItem("save_" + userCode)) || { saldo:300 };
    saldo = saved.saldo;
    document.getElementById("saldoValor").textContent = saldo;

    document.getElementById("loginDiv").style.display = 'none';
    document.getElementById("gameDiv").style.display = 'flex';

    if(debugMode) document.getElementById("debugPanel").style.display = 'block';
}

function cambiarApuesta(val) {
    const input = document.getElementById("apuesta");
    input.value = Math.max(1, Number(input.value) + val);
}

function agregarSenselios() {
    const val = parseInt(document.getElementById("addCash").value) || 0;
    saldo += val;
    document.getElementById("saldoValor").textContent = saldo;
    save();
}

function save() {
    localStorage.setItem("save_" + userCode, JSON.stringify({ saldo }));
}

function randomWeighted() {
    const probs = [
        {num:1,p:19.4},{num:2,p:19.4},{num:3,p:14.9},{num:4,p:14.9},
        {num:5,p:Math.round((100-(19.4*2+14.9*2+8.4))/2*10)/10},
        {num:6,p:Math.round((100-(19.4*2+14.9*2+8.4))/2*10)/10},
        {num:7,p:8.4}
    ];
    const r = Math.random()*100;
    let acum=0;
    for(const p of probs){
        acum+=p.p;
        if(r<acum) return p.num;
    }
    return 1;
}

function spin() {
    let apuesta = parseInt(document.getElementById("apuesta").value);
    if(apuesta<1 || apuesta>saldo) return alert("Cantidad inválida");
    saldo -= apuesta;
    document.getElementById("saldoValor").textContent = saldo;
    save();

    forcedNumbers = [];
    const forcedInput = document.getElementById("forcedInput");
    if(debugMode && forcedInput.value.trim()) {
        forcedNumbers = forcedInput.value.split(',').map(x => x.trim());
    }

    spinBtn.disabled = true;
    let intervals = [];
    slots.forEach((slot, index) => {
        const interval = setInterval(() => {
            const num = randomWeighted();
            slot.textContent = num;
            slot.style.color = colors[num-1];
            slot.classList.remove('maldito');
        }, 80);
        intervals.push(interval);

        setTimeout(() => {
            clearInterval(interval);
            // Número forzado
            let finalNum = forcedNumbers[index] || randomWeighted();
            let maldito=false;
            if(typeof finalNum==='string' && finalNum.startsWith('(') && finalNum.endsWith(')')){
                maldito=true;
                finalNum=parseInt(finalNum.replace(/[()]/g,''));
            } else if(Math.random()<0.01) maldito=true;

            slot.textContent=finalNum;
            slot.style.color=maldito?'black':colors[finalNum-1];
            slot.classList.toggle('maldito',maldito);

            plac.play();

            if(index===slots.length-1){
                spinBtn.disabled=false;
                calcularResultado(apuesta);
            }
        }, 1000 + index*600);
    });
}

function calcularResultado(apuesta){
    const nums = slots.map(s=>parseInt(s.textContent));
    const allSame = nums[0]===nums[1] && nums[1]===nums[2];
    let ganancia = 0;

    if(allSame){
        ganancia = apuesta*3;
    }

    // Si algún número es maldito, restar lo que fuera a ganar
    if(slots.some(s=>s.classList.contains('maldito'))){
        ganancia -= apuesta;
    }

    saldo += ganancia;
    document.getElementById("saldoValor").textContent = saldo;
    save();
}

</script>

</body>
</html>
