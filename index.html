<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Tragaperras</title>

<!-- Fuente Ready Player 2P -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        background: #111;
        color: white;
        font-family: 'Press Start 2P', monospace;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        flex-direction: column;
    }

    .slot-machine {
        background: #222;
        padding: 30px;
        border: 4px solid white;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .slots {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
    }

    .slot {
        width: 90px;
        height: 120px;
        border: 3px solid white;
        font-size: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: black;
        transition: color 0.2s, transform 0.2s;
    }

    .slot.cursed {
        animation: cursedAnim 0.5s infinite alternate;
        color: black !important;
        border: 3px solid white !important;
    }

    @keyframes cursedAnim {
        0% { color: black; transform: translate(0,0); }
        25% { color: red; transform: translate(-2px,0); }
        50% { color: white; transform: translate(2px,0); }
        75% { color: red; transform: translate(0,-2px); }
        100% { color: white; transform: translate(0,2px); }
    }

    button, .btn {
        font-family: 'Press Start 2P', monospace;
        font-size: 14px;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        background: white;
        color: black;
        border: 3px solid black;
        text-shadow: 2px 2px 0 #000;
    }

    button:disabled, .btn:disabled {
        background: gray;
        cursor: not-allowed;
    }

    .apuesta {
        display: flex;
        align-items: center;
        margin-top: 15px;
    }

    .apuesta input[type=number] {
        font-family: 'Press Start 2P', monospace;
        font-size: 16px;
        width: 60px;
        text-align: center;
        margin: 0 5px;
        padding: 5px;
        border: 3px solid white;
        background: black;
        color: white;
    }

    .saldo {
        margin-bottom: 10px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .saldo img {
        width: 24px;
        height: 24px;
    }
</style>
</head>
<body>

<div id="loginDiv">
    <p>Introduce tu código:</p>
    <input type="text" id="loginCode" placeholder="Código">
    <button id="loginBtn">Entrar</button>
</div>

<div class="slot-machine" id="gameDiv" style="display:none;">
    <div class="saldo">
        <span id="saldo">0</span>
        <img src="senselios.png" alt="Senselios">
    </div>

    <div class="slots">
        <div class="slot" id="slot1">1</div>
        <div class="slot" id="slot2">1</div>
        <div class="slot" id="slot3">1</div>
    </div>

    <div class="apuesta">
        <button class="btn" id="menos">-</button>
        <input type="number" id="cantidad" value="10" min="1">
        <button class="btn" id="mas">+</button>
    </div>

    <button id="spinBtn">GIRAR</button>
</div>

<audio id="placSound" src="plac.mp3"></audio>

<script>
const slots = [
    document.getElementById("slot1"),
    document.getElementById("slot2"),
    document.getElementById("slot3")
];
const spinBtn = document.getElementById("spinBtn");
const plac = document.getElementById("placSound");
const saldoEl = document.getElementById("saldo");
const cantidadEl = document.getElementById("cantidad");
const btnMas = document.getElementById("mas");
const btnMenos = document.getElementById("menos");

let saldo = 0;
let debugMode = false;

// Login
document.getElementById("loginBtn").addEventListener("click",()=>{
    const code = document.getElementById("loginCode").value.trim();
    if(!code) { alert("Pon un código"); return; }

    // Verificamos si existe partida
    const saved = localStorage.getItem("slot_"+code);
    if(saved){
        const data = JSON.parse(saved);
        saldo = data.saldo;
        debugMode = data.debugMode || false;
    } else {
        saldo = 300;
        debugMode = (code === "GodIsHere");
    }

    saldoEl.textContent = saldo;

    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("gameDiv").style.display = "flex";

    currentCode = code;
});

// Guardar partida
function saveGame(){
    if(!currentCode) return;
    localStorage.setItem("slot_"+currentCode, JSON.stringify({saldo: saldo, debugMode: debugMode}));
}

// Botones + y -
btnMas.addEventListener("click", () => { cantidadEl.value = Number(cantidadEl.value) + 1; });
btnMenos.addEventListener("click", () => { cantidadEl.value = Math.max(1, Number(cantidadEl.value) - 1); });

// Probabilidades y colores
const probabilidades = [
    {num: 1, prob: 0.194, color: "#FFD700"},
    {num: 2, prob: 0.194, color: "#FFA500"},
    {num: 3, prob: 0.149, color: "#00FF00"},
    {num: 4, prob: 0.149, color: "#00FFFF"},
    {num: 5, prob: 0.0, color: "#FF00FF"}, 
    {num: 6, prob: 0.0, color: "#FFFFFF"},
    {num: 7, prob: 0.084, color: "#FF0000"}
];
const restante = 1 - probabilidades.reduce((a,b)=>a+b.prob,0);
probabilidades[4].prob = restante/2;
probabilidades[5].prob = restante/2;

function elegirNumero() {
    const r = Math.random();
    let acum = 0;
    for(let p of probabilidades){
        acum += p.prob;
        if(r < acum) return p.num;
    }
    return 5; 
}

let currentCode = null;

function spin() {
    let cantidad = Number(cantidadEl.value);
    if(cantidad > saldo) { alert("No tienes suficientes Senselios."); return; }

    saldo -= cantidad;
    saldoEl.textContent = saldo;

    spinBtn.disabled = true;

    let resultados = [];
    let intervals = [];

    slots.forEach((slot,index)=>{
        slot.classList.remove("cursed");
        const interval = setInterval(()=>{
            const n = Math.floor(Math.random()*7)+1;
            slot.textContent = n;
            slot.style.color = probabilidades.find(p=>p.num===n).color;
        }, 80);
        intervals.push(interval);

        setTimeout(()=>{
            clearInterval(interval);
            let n = elegirNumero();

            // 1% de maldito o forzar en debug
            let esMaldito = Math.random() < 0.01;
            if(debugMode && forcedNumbers && forcedNumbers[index]){
                const f = forcedNumbers[index];
                if(f.endsWith(")")) esMaldito=true;
                n = Number(f.replace(/\(|\)/g,""));
            }

            resultados[index] = {num: n, maldito: esMaldito};

            slot.textContent = n;
            slot.style.color = probabilidades.find(p=>p.num===n).color;
            if(esMaldito) slot.classList.add("cursed");

            plac.play();

            if(index === slots.length-1){
                spinBtn.disabled = false;

                let iguales = resultados.every(r => r.num === resultados[0].num);
                let premio = iguales ? cantidad*3 : 0;

                if(resultados.some(r=>r.maldito)) premio = Math.max(0,premio-cantidad);

                saldo += premio;
                saldoEl.textContent = saldo;

                saveGame();
            }

        }, 1000 + index*600);
    });
}

spinBtn.addEventListener("click", spin);

</script>
</body>
</html>
